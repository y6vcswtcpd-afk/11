<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡è¯¦æƒ… - è‰ºæœ¯å›¾åº“</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/detail.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* è¯¦æƒ…é¡µä¸“ç”¨æ ·å¼ */
        .detail-header {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            background: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .detail-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .detail-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .detail-content {
                grid-template-columns: 1fr;
            }
        }
        
        .image-viewer {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .image-viewer img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .image-zoom {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.8);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }
        
        .image-info {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .image-title {
            font-size: 28px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .image-author {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #666;
        }
        
        .author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .author-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .author-name {
            font-weight: 500;
        }
        
        .image-description {
            line-height: 1.8;
            color: #555;
            margin-bottom: 25px;
        }
        
        .image-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
        }
        
        .image-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .action-btn {
            padding: 10px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-like {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e1e5e9;
        }
        
        .btn-like:hover {
            background: #f0f2f5;
        }
        
        .btn-like.liked {
            background: #ffeef0;
            color: #e74c3c;
            border-color: #fad3d7;
        }
        
        .btn-download {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .image-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .tag {
            background: #f0f0f0;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            color: #555;
        }
        
        .tag:hover {
            background: #e0e0e0;
        }
        
        .info-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .info-card h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-card h3 i {
            color: #667eea;
        }
        
        .comment-form {
            margin-bottom: 30px;
        }
        
        .comment-form textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            min-height: 100px;
            margin-bottom: 10px;
            font-family: inherit;
        }
        
        .comment-form button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .comments-list {
            margin-top: 20px;
        }
        
        .comment-item {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        
        .comment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .comment-author {
            font-weight: 500;
            font-size: 14px;
        }
        
        .comment-date {
            font-size: 12px;
            color: #999;
            margin-left: auto;
        }
        
        .comment-text {
            color: #555;
            line-height: 1.6;
        }
        
        .related-images {
            margin-top: 40px;
        }
        
        .related-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .related-item {
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }
        
        .related-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            transition: transform 0.3s;
        }
        
        .related-item:hover img {
            transform: scale(1.05);
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            text-decoration: none;
            margin-bottom: 20px;
        }
        
        .back-btn:hover {
            text-decoration: underline;
        }
        
        /* æ”¾å¤§é•œæ•ˆæœ */
        .zoom-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .zoom-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .zoomed-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        
        .close-zoom {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <header class="detail-header">
        <div class="container">
            <a href="gallery.html" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                <span>è¿”å›å›¾åº“</span>
            </a>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="detail-main">
        <div class="detail-container">
            <div class="detail-content">
                <!-- å·¦ä¾§ï¼šå›¾ç‰‡æŸ¥çœ‹å™¨ -->
                <div class="detail-left">
                    <div class="image-viewer">
                        <img id="detailImage" src="" alt="å›¾ç‰‡è¯¦æƒ…">
                        <div class="image-zoom" id="zoomBtn">
                            <i class="fas fa-search-plus"></i>
                        </div>
                    </div>
                    
                    <div class="image-info">
                        <h1 id="imageTitle">å›¾ç‰‡æ ‡é¢˜</h1>
                        <div class="image-author">
                            <div class="author-avatar">
                                <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="ä½œè€…å¤´åƒ">
                            </div>
                            <span class="author-name" id="imageAuthor">ä½œè€…åç§°</span>
                            <span class="upload-date" id="uploadDate">ä¸Šä¼ äº 2023-01-15</span>
                        </div>
                        
                        <p class="image-description" id="imageDescription">
                            è¿™æ˜¯ä¸€å¼ ç¾ä¸½çš„é£æ™¯å›¾ç‰‡ï¼Œæ‹æ‘„äº2023å¹´1æœˆ15æ—¥ã€‚ç”»é¢ä¸­å±•ç°äº†å£®ä¸½çš„å±±å·å’Œæ¸…æ¾ˆçš„æ¹–æ°´ï¼Œé˜³å…‰é€è¿‡äº‘å±‚æ´’åœ¨æ¹–é¢ä¸Šï¼Œå½¢æˆç¾ä¸½çš„å…‰å½±æ•ˆæœã€‚
                        </p>
                        
                        <div class="image-stats">
                            <div class="stat-item">
                                <i class="fas fa-heart"></i>
                                <span id="likeCount">156</span> å–œæ¬¢
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-eye"></i>
                                <span id="viewCount">1,234</span> æµè§ˆ
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-download"></i>
                                <span id="downloadCount">89</span> ä¸‹è½½
                            </div>
                        </div>
                        
                        <div class="image-actions">
                            <button class="action-btn btn-like" id="likeBtn">
                                <i class="far fa-heart"></i>
                                <span>å–œæ¬¢</span>
                            </button>
                            <button class="action-btn btn-download" id="downloadBtn">
                                <i class="fas fa-download"></i>
                                <span>ä¸‹è½½</span>
                            </button>
                        </div>
                        
                        <div class="image-tags" id="imageTags">
                            <span class="tag">é£æ™¯</span>
                            <span class="tag">è‡ªç„¶</span>
                            <span class="tag">å±±æ°´</span>
                            <span class="tag">æˆ·å¤–</span>
                        </div>
                    </div>
                </div>
                
                <!-- å³ä¾§ï¼šä¿¡æ¯å’Œç›¸å…³å›¾ç‰‡ -->
                <div class="detail-right">
                    <div class="info-card">
                        <h3><i class="fas fa-chart-line"></i> ç»Ÿè®¡æ•°æ®</h3>
                        <p>åˆ†ç±»: <span id="imageCategory">é£æ™¯</span></p>
                        <p>å°ºå¯¸: <span id="imageSize">1920x1080</span></p>
                        <p>æ–‡ä»¶å¤§å°: <span id="fileSize">2.4 MB</span></p>
                        <p>ä¸Šä¼ æ—¶é—´: <span id="uploadTime">2023-01-15 14:30</span></p>
                    </div>
                    
                    <div class="info-card">
                        <h3><i class="fas fa-comment"></i> è¯„è®º</h3>
                        <div class="comment-form">
                            <textarea placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."></textarea>
                            <button type="submit">å‘è¡¨è¯„è®º</button>
                        </div>
                        
                        <div class="comments-list" id="commentsList">
                            <div class="comment-item">
                                <div class="comment-header">
                                    <div class="comment-avatar">
                                        <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="ç”¨æˆ·å¤´åƒ">
                                    </div>
                                    <span class="comment-author">æ‘„å½±çˆ±å¥½è€…</span>
                                    <span class="comment-date">2023-01-16</span>
                                </div>
                                <p class="comment-text">
                                    è¿™å¼ ç…§ç‰‡çš„å…‰å½±æ•ˆæœå¤ªæ£’äº†ï¼æ„å›¾ä¹Ÿå¾ˆå®Œç¾ï¼Œè®©äººä»¿ä½›èº«ä¸´å…¶å¢ƒã€‚
                                </p>
                            </div>
                            
                            <div class="comment-item">
                                <div class="comment-header">
                                    <div class="comment-avatar">
                                        <img src="https://randomuser.me/api/portraits/women/65.jpg" alt="ç”¨æˆ·å¤´åƒ">
                                    </div>
                                    <span class="comment-author">è‰ºæœ¯è¯„è®ºå®¶</span>
                                    <span class="comment-date">2023-01-15</span>
                                </div>
                                <p class="comment-text">
                                    è‰²å½©æ­é…éå¸¸å’Œè°ï¼Œç‰¹åˆ«æ˜¯å¤©ç©ºå’Œæ°´é¢çš„è¿‡æ¸¡å¤„ç†å¾—å¾ˆè‡ªç„¶ã€‚
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-card related-images">
                        <h3><i class="fas fa-images"></i> ç›¸å…³å›¾ç‰‡</h3>
                        <div class="related-grid" id="relatedImages">
                            <!-- ç›¸å…³å›¾ç‰‡å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- å›¾ç‰‡æ”¾å¤§é•œ -->
    <div class="zoom-overlay" id="zoomOverlay">
        <span class="close-zoom" id="closeZoom">
            <i class="fas fa-times"></i>
        </span>
        <img class="zoomed-image" id="zoomedImage" src="" alt="æ”¾å¤§å›¾ç‰‡">
    </div>

    <!-- è„šæœ¬æ–‡ä»¶ -->
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/detail.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ–¼ï¸ å›¾ç‰‡è¯¦æƒ…é¡µåŠ è½½å®Œæˆ');
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!authSystem.isLoggedIn()) {
                authSystem.redirectToLogin();
                return;
            }
            
            // ä»URLè·å–å›¾ç‰‡ID
            const urlParams = new URLSearchParams(window.location.search);
            const imageId = urlParams.get('id');
            
            if (!imageId) {
                console.error('æœªæ‰¾åˆ°å›¾ç‰‡ID');
                window.location.href = 'gallery.html';
                return;
            }
            
            // è·å–å›¾ç‰‡æ•°æ®
            const images = JSON.parse(localStorage.getItem('images') || '[]');
            const imageData = images.find(img => img.id == imageId);
            
            if (!imageData) {
                console.error('æœªæ‰¾åˆ°å›¾ç‰‡æ•°æ®');
                window.location.href = 'gallery.html';
                return;
            }
            
            // æ›´æ–°é¡µé¢
            updatePage(imageData);
            
            // å¢åŠ æµè§ˆé‡
            incrementViews(imageData);
            
            // ç»‘å®šäº‹ä»¶
            bindEvents(imageData);
            
            // åŠ è½½ç›¸å…³å›¾ç‰‡
            loadRelatedImages(imageData);
            
            // æ›´æ–°å½“å‰ç”¨æˆ·çš„å†å²è®°å½•
            updateUserHistory(imageId);
        });
        
        // æ›´æ–°é¡µé¢å†…å®¹
        function updatePage(image) {
            document.title = `${image.title} - å›¾ç‰‡è¯¦æƒ…`;
            document.getElementById('detailImage').src = image.url;
            document.getElementById('detailImage').alt = image.title;
            document.getElementById('imageTitle').textContent = image.title;
            document.getElementById('imageAuthor').textContent = image.author;
            document.getElementById('imageDescription').textContent = image.description || 'è¿™å¼ å›¾ç‰‡è¿˜æ²¡æœ‰æè¿°...';
            document.getElementById('likeCount').textContent = image.likes;
            document.getElementById('viewCount').textContent = image.views;
            document.getElementById('downloadCount').textContent = image.downloads || 0;
            document.getElementById('uploadDate').textContent = `ä¸Šä¼ äº ${utils.formatDate(image.uploadDate)}`;
            document.getElementById('imageCategory').textContent = image.category;
            
            // æ›´æ–°æ ‡ç­¾
            const tagsContainer = document.getElementById('imageTags');
            if (tagsContainer && image.tags) {
                tagsContainer.innerHTML = image.tags.map(tag => 
                    `<span class="tag">${tag}</span>`
                ).join('');
            }
            
            // æ›´æ–°å–œæ¬¢æŒ‰é’®çŠ¶æ€
            const currentUser = authSystem.getCurrentUser();
            if (currentUser && currentUser.favorites.includes(image.id)) {
                document.getElementById('likeBtn').classList.add('liked');
                document.getElementById('likeBtn').innerHTML = '<i class="fas fa-heart"></i><span>å·²å–œæ¬¢</span>';
            }
        }
        
        // å¢åŠ æµè§ˆé‡
        function incrementViews(image) {
            image.views = (image.views || 0) + 1;
            updateImageData(image);
        }
        
        // ç»‘å®šäº‹ä»¶
        function bindEvents(image) {
            // å–œæ¬¢æŒ‰é’®
            document.getElementById('likeBtn').addEventListener('click', function() {
                toggleLike(image);
            });
            
            // ä¸‹è½½æŒ‰é’®
            document.getElementById('downloadBtn').addEventListener('click', function() {
                downloadImage(image);
            });
            
            // æ”¾å¤§é•œåŠŸèƒ½
            const zoomBtn = document.getElementById('zoomBtn');
            const zoomOverlay = document.getElementById('zoomOverlay');
            const zoomedImage = document.getElementById('zoomedImage');
            const closeZoom = document.getElementById('closeZoom');
            
            if (zoomBtn && zoomOverlay && zoomedImage) {
                zoomBtn.addEventListener('click', function() {
                    zoomedImage.src = image.url;
                    zoomOverlay.classList.add('active');
                });
                
                closeZoom.addEventListener('click', function() {
                    zoomOverlay.classList.remove('active');
                });
                
                zoomOverlay.addEventListener('click', function(e) {
                    if (e.target === zoomOverlay) {
                        zoomOverlay.classList.remove('active');
                    }
                });
            }
            
            // æ ‡ç­¾ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    const tagName = this.textContent;
                    window.location.href = `gallery.html?tag=${encodeURIComponent(tagName)}`;
                });
            });
        }
        
        // åˆ‡æ¢å–œæ¬¢çŠ¶æ€
        function toggleLike(image) {
            const currentUser = authSystem.getCurrentUser();
            if (!currentUser) {
                authSystem.showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const likeBtn = document.getElementById('likeBtn');
            const isLiked = likeBtn.classList.contains('liked');
            
            if (isLiked) {
                // å–æ¶ˆå–œæ¬¢
                image.likes--;
                currentUser.favorites = currentUser.favorites.filter(id => id != image.id);
                likeBtn.classList.remove('liked');
                likeBtn.innerHTML = '<i class="far fa-heart"></i><span>å–œæ¬¢</span>';
                authSystem.showToast('å·²å–æ¶ˆå–œæ¬¢', 'info');
            } else {
                // å–œæ¬¢
                image.likes++;
                currentUser.favorites.push(image.id);
                likeBtn.classList.add('liked');
                likeBtn.innerHTML = '<i class="fas fa-heart"></i><span>å·²å–œæ¬¢</span>';
                authSystem.showToast('å·²æ·»åŠ åˆ°å–œæ¬¢', 'success');
            }
            
            // æ›´æ–°è®¡æ•°æ˜¾ç¤º
            document.getElementById('likeCount').textContent = image.likes;
            
            // æ›´æ–°æ•°æ®
            updateImageData(image);
            authSystem.updateUser(currentUser);
        }
        
        // ä¸‹è½½å›¾ç‰‡
        function downloadImage(image) {
            const currentUser = authSystem.getCurrentUser();
            if (!currentUser) {
                authSystem.showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            // æ¨¡æ‹Ÿä¸‹è½½
            console.log('ä¸‹è½½å›¾ç‰‡:', image.title);
            authSystem.showToast('å¼€å§‹ä¸‹è½½...', 'info');
            
            // å¢åŠ ä¸‹è½½è®¡æ•°
            image.downloads = (image.downloads || 0) + 1;
            document.getElementById('downloadCount').textContent = image.downloads;
            updateImageData(image);
            
            // å®é™…ä¸‹è½½åŠŸèƒ½
            setTimeout(() => {
                const link = document.createElement('a');
                link.href = image.url;
                link.download = `${image.title.replace(/\s+/g, '_')}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                authSystem.showToast('ä¸‹è½½å®Œæˆ', 'success');
            }, 1000);
        }
        
        // åŠ è½½ç›¸å…³å›¾ç‰‡
        function loadRelatedImages(image) {
            const images = JSON.parse(localStorage.getItem('images') || '[]');
            const relatedImages = images
                .filter(img => 
                    img.id != image.id && 
                    (img.category === image.category || 
                     img.tags.some(tag => image.tags.includes(tag)))
                )
                .slice(0, 6); // æœ€å¤šæ˜¾ç¤º6å¼ ç›¸å…³å›¾ç‰‡
            
            const relatedContainer = document.getElementById('relatedImages');
            if (relatedContainer) {
                relatedContainer.innerHTML = relatedImages.map(img => `
                    <div class="related-item" data-id="${img.id}">
                        <img src="${img.thumbnail}" alt="${img.title}">
                    </div>
                `).join('');
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                document.querySelectorAll('.related-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        window.location.href = `detail.html?id=${id}`;
                    });
                });
            }
        }
        
        // æ›´æ–°ç”¨æˆ·å†å²è®°å½•
        function updateUserHistory(imageId) {
            const currentUser = authSystem.getCurrentUser();
            if (!currentUser) return;
            
            // æ·»åŠ åˆ°æµè§ˆå†å²
            if (!currentUser.history.includes(imageId)) {
                currentUser.history.unshift(imageId);
                
                // æœ€å¤šä¿ç•™50æ¡å†å²è®°å½•
                if (currentUser.history.length > 50) {
                    currentUser.history = currentUser.history.slice(0, 50);
                }
                
                authSystem.updateUser(currentUser);
            }
        }
        
        // æ›´æ–°å›¾ç‰‡æ•°æ®
        function updateImageData(image) {
            const images = JSON.parse(localStorage.getItem('images') || '[]');
            const index = images.findIndex(img => img.id === image.id);
            if (index !== -1) {
                images[index] = image;
                localStorage.setItem('images', JSON.stringify(images));
            }
        }
    </script>
</body>
</html>